---
title: "chTKCat Operations manual"
author: "Patrice Godard"
date:  "`r format(Sys.time(), '%B %d, %Y')`"
output:
   rmarkdown::html_vignette:
     number_sections: yes
     self_contained: yes
     toc: yes
     fig_width: 7
     fig_height: 5
vignette: >
   %\VignetteIndexEntry{chTKCat Operations manual}
   %\VignetteEncoding{UTF-8}
   %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, message=FALSE, echo=FALSE, include=FALSE, cache=FALSE}
library(knitr)
opts_chunk$set(
   include=TRUE,
   echo=FALSE,
   message=FALSE,
   warning=FALSE,
   cache=FALSE,
   cache.lazy=FALSE
)
## The following line is to avoid building errors on CRAN
knitr::opts_chunk$set(eval=Sys.getenv("USER") %in% c("pgodard"))
library(TKCat)
```

```{r child = 'supp/urls.Rmd'}
```


<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# Introduction

```{r child = 'supp/genIntro.Rmd'}
```

This vignette describes how to create and administrate
a TKCat [ClickHouse][clickhouse] instance.
An [other vignette][chuguide] focuses how TKCat can be used
with a ClickHouse database.
Users should also refer to the [general TKCat user guide][uguide].

<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# Instantiating the ClickHouse database

## Install ClickHouse, initialize and configure the TKCat instance

The ClickHouse docker container supporting TKCat,
its initialization and its configuration procedures
are implemented
here: [S01-install-and-init.R](https://github.com/patzaw/TKCat/blob/master/ClickHouse/S01-install-and-init.R)
	
This script should be adapted according to requirements and needs.

The data are stored in the `TKCAT_HOME` folder.

## Cleaning and removing a TKCat instance

Stop and remove the docker container.

```{sh, eval=FALSE}

docker stop ucb_tbn_tkcat
docker rm ucb_tbn_tkcat
docker volume prune -f
# Remove the folder with all the data: `$TKCAT_HOME`.`
sudo rm -rf ~/Documents/Projects/TKCat_UCB_TBN

```


<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# User management

User management requires admin right on the database.

## Creation

```{r, eval=FALSE}
k <- chTKCat(user="pgodard")
create_chTKCat_user(k, login="lfrancois", contact=NA)
```

The function will require to setup a password for the new user.

## Drop

```{r, eval=FALSE}
drop_chTKCat_user(k, login="lfrancois")
```



<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# MDB management

<!-------------->
## MDB Creation

```{r, eval=FALSE}
toCreate <- readLines("~/Shared/Data-Science/Data-Source-Model-Repository/01-lfrancois-Resources/All-Resources.txt")
for(r in toCreate){
   if(!r %in% list_MDBs(k, withInfo=FALSE)){
      create_chMDB(k, r)
   }
   set_chMDB_access(k, r, public=TRUE)
   add_chMDB_user(k, r, "lfrancois", admin=TRUE)
}
```

<!-------------->
## Populating MDB

```{r, eval=FALSE}
toFeed <- readLines("~/Shared/Data-Science/Data-Source-Model-Repository/01-pgodard-Resources/All-Resources.txt")
lc <- scan_fileMDBs(
   "~/Shared/Data-Science/Data-Source-Model-Repository/",
   subdirs=toFeed
)
# explore_MDBs(lc)
for(r in toFeed){
   message(r)
   lr <- as_memoMDB(lc[[r]])
   cr <- as_chMDB(lr, k, overwrite=TRUE)
}
```


<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# Implementation

<!-------------->
## Data models

### Default database

The default database stores information about chTKCat instance, users
and user access.

```{r}
plot(TKCat:::DEFAULT_DATA_MODEL)
```

### Modeled databases

Modeled databases (MDB) are stored in dedicated database in chTKCat.
Their data model is provided in dedicated tables described below.

```{r}
plot(TKCat:::CHMDB_DATA_MODEL)
```
